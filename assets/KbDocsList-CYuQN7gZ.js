import{c as f,R as W,h as H,d as m,r as x,j as s,f as v}from"./index-Delt0bgx.js";import{l as P,g as B,k as Q,p as g,c as E}from"./ajax-CQpykg4a.js";import{S as J}from"./delete-DciOlMDO.js";import{S as X}from"./edit-DwQ1b_9m.js";import{S as Y}from"./plus-C9HrPsMn.js";import{B as j}from"./Button-hXJdwpCN.js";import{S as Z}from"./TextBox-D2cRLm9M.js";import{s as A,h as _}from"./utils-B3TvvZ68.js";import{u as I}from"./useSelectedBot-CoVHYjdL.js";import{f as L}from"./bots-a-FYZmH9.js";import{P as ee}from"./PageHeader-DsjpDQQj.js";import{S as te}from"./send-DE2V3rLd.js";import{F as se,a as oe,d as ne}from"./index-BSCKvjr-.js";const d=H(()=>({page:1,rowsPerPage:10,totalDocs:0,docsList:[],isLoading:!1,kbDocs:{}}));function ae(){const o=f(a=>a.organizationId),[n]=I();W.useEffect(()=>{ie()},[n,o]);const t=d(a=>a.docsList),e=d(a=>a.isLoading);return[t,e]}async function ie(o=1,n=10){const{organizationId:t}=f.getState(),{selectedBotId:e}=m.getState();if(!t||!e)return;const{botId:a}=d.getState(),i={page:o,rowsPerPage:n,isLoading:!0};a!==e&&(i.docsList=[]),d.setState(i);const r=await P.get(`/bot/${t}/${e}/knowledge-base/list`);d.setState({botId:e,docsList:r,totalDocs:r.length,isLoading:!1})}async function re(o){const{selectedBotId:n}=m.getState(),{organizationId:t}=f.getState(),{kbDocs:e}=d.getState(),a=await B(`/bot/${t}/${n}/knowledge-base/list`);d.setState(i=>({kbDocs:{...i.docsList||{},[String(n)]:a}}))}async function ce(o){const{selectedBotId:n}=m.getState(),{organizationId:t}=f.getState();if(!n)throw new Error("No bot selected");const e=await g(`/bot/${t}/${n}/knowledge-base`,o);return d.setState(a=>{const i=[...a.docsList||[]];if(!Array.isArray(i))return{docsList:[e],totalDocs:1};if(o._id){const r=i.findIndex(c=>c._id===e._id);r>=0?i[r]=e:i.push(e)}else i.push(e);return{docsList:i,totalDocs:i.length}}),e}async function le(o){const{selectedBotId:n}=m.getState(),{organizationId:t}=f.getState();if(!n)throw new Error("No bot selected");await Q(`/bot/${t}/${n}/knowledge-base/${o}`,o),d.setState(e=>{const i=[...e.docsList||[]].filter(r=>r._id!==o);return{docsList:i,totalDocs:i.length}})}async function Le(o){if(!(o!=null&&o.length))return[];const{organizationId:n}=f.getState(),{selectedBotId:t}=m.getState();return await B(`/bot/${n}/${t}/knowledge-base/list?${o.map(e=>`docIds=${e}`).join("&")}`)}async function ke(o){const{organizationId:n}=f.getState(),{selectedBotId:t}=m.getState(),e=await g(`/bot/${n}/${t}/add-training-media`,o);e.trainingMedia?t?(L(t,{trainingMedia:e.trainingMedia}),await z(t,n)):console.error("Bot ID is undefined."):console.warn("trainingMedia is null or undefined.")}async function $e(o){const{organizationId:n}=f.getState(),{selectedBotId:t}=m.getState(),e=new FormData;if(e.append("file",o),!(!n||!t))try{const a=await g(`/bot/${n}/${t}/add-training-media`,e);L(t,{trainingMedia:a.trainingMedia}),await z(t,n)}catch{throw new Error("File upload failed. Please try again.")}}async function z(o,n){const t=await g(`/bot/${n}/${o}/knowledge-base/train`,{});return d.setState(e=>{const a={...e.kbDocs||{}};return delete a[o],{kbDocs:a}}),re().catch(e=>console.error("Error fetching Knowledge base content:",e)),t}async function de(o,n,t){const e=await g(`/bot/${n}/${t}/add-bot-tax-details`,o),{_id:a,botDetailsForVerification:i}=e;return L(a,{botDetailsForVerification:i}),i}function F({onDone:o,initial:n,onUpdate:t}){const[e,a]=x.useState(n||{question:"",content:"",_id:""}),i=(c,h)=>{a(S=>({...S,[c]:h}))},r=async()=>{const c=await ce(e);t==null||t(c),o()};return s.jsxs("div",{className:"flex flex-col gap-4",children:[s.jsx("div",{className:"font-bold text-lg pb-1 text-center",children:"Add document"}),s.jsxs(se,{value:e,onChange:a,children:[s.jsx(oe,{field:"question",placeholder:"Provide title or question for the content",label:"Question",wrapperClassName:"h-6",onChange:c=>i("question",c)}),s.jsx(ne,{field:"content",placeholder:"Provide content or answer for the question",label:"Content",className:"h-24",onChange:c=>i("content",c)})]}),s.jsx("div",{className:"text-center",children:s.jsx(j,{icon:s.jsx(te,{}),size:"lg",type:"rounded",onClick:r,className:"bg-[#49d4a1]"})})]})}function ue(o){const{activeIndex:n,onNavigate:t=()=>{},docsList:e,onUpdate:a}=o,i=f(l=>l.organizationId),[r]=I(),[c,h]=ae(),S=e??c,[b,M]=x.useState(10),[p,N]=x.useState(1),[D,q]=x.useState(""),R=[10,15,20,25],y=(S||[]).filter(l=>{var u,$;return!D||((u=l.question)==null?void 0:u.toLowerCase().includes(D.toLowerCase()))||(($=l.content)==null?void 0:$.toLowerCase().includes(D.toLowerCase()))}),w=Math.ceil(y.length/b),C=(p-1)*b,T=C+b,k=y.slice(C,T),K=()=>_(),V=()=>A(s.jsx(F,{onDone:K,onUpdate:a}),{showCloseButton:!0,width:"700px"});x.useEffect(()=>{p>w&&N(1)},[y.length,w,p]);const O=l=>{const u=typeof l=="string"?parseInt(l,10):l;typeof u=="number"&&!isNaN(u)&&(M(u),N(1))},U=l=>{l<1||l>w||N(l)},G=async()=>{try{await de({botDetailsForVerification:{integrationUrl:""}},i,r)?v(!0,"The bot deployed successfully","success"):v(!0,"Not able to deploy the bot. Try after sometime!","error"),n&&t(n+1)}catch(l){console.error("Error during bot verification:",l),v(!0,"Not able to verify the bot. Try after sometime!","error")}};return s.jsxs("div",{className:"flex flex-col min-h-full",children:[!e&&!n&&s.jsx("div",{className:"mb-4",children:s.jsx(ee,{title:"Chat Bot Knowledge",icon:Y,search:!0,onSearchChange:q,onClick:V})}),s.jsxs("div",{className:E("w-full border border-mildGreyBGAlt rounded bg-white flex-1 flex flex-col",{"opacity-50":h}),children:[s.jsx("div",{className:"flex-1",children:h?s.jsx("div",{className:"flex justify-center items-center h-32 text-gray-500",children:"Loading..."}):k.length===0?s.jsx("div",{className:"flex justify-center items-center h-32 text-gray-500",children:"No documents found."}):k.map((l,u)=>s.jsx(fe,{doc:l,index:C+u,onUpdate:a},l._id))}),!e&&s.jsx("div",{className:"w-full flex flex-row px-4 py-3 gap-8 border-t border-gray-100 bg-white mt-auto",children:s.jsx(xe,{count:b,counts:R,currentPage:p,totalPages:w,onChangeCount:O,goToPage:U})})]}),n&&!e&&s.jsx("div",{className:"flex mt-6 justify-end",children:s.jsx(j,{label:"GENERATE",onClick:G})})]})}function fe({doc:o,index:n,onUpdate:t}){var r;const[,e]=I(),a=()=>{A(s.jsx(F,{onDone:_,initial:{question:o.question||"",content:o.content||"",_id:o._id},onUpdate:t}),{showCloseButton:!0,width:"700px"})},i=async c=>{console.log("Deleting document with ID:",c),await le(c)};return s.jsxs("div",{className:E("w-full flex flex-row px-4 py-3 gap-8 border-b border-gray-100",{"bg-white":n%2!==0,"bg-[#f7f7f7]":n%2===0}),children:[s.jsxs("div",{className:"flex flex-col gap-1 flex-1",children:[!!o.question&&s.jsx("span",{className:"font-normal text-md",children:o.question}),s.jsx("div",{className:"text-xs overflow-hidden line-clamp-3",children:o.content}),!!o.sourceDocument&&((r=e==null?void 0:e.trainingMedia)==null?void 0:r.length)>0&&s.jsx(me,{document:o,trainingMedia:e.trainingMedia})]}),s.jsxs("div",{className:"flex flex-row my-auto w-[130px]",children:[s.jsx(j,{icon:s.jsx(J,{height:24,width:24}),type:"plain",className:"me-8",onClick:()=>i(o._id)}),s.jsx(j,{icon:s.jsx(X,{height:24,width:24}),type:"plain",className:"me-8",onClick:a})]})]})}function me({document:o,trainingMedia:n}){const t=o.sourceDocument,e=x.useMemo(()=>{if(!n||!t)return null;const a=n.find(r=>r.docId===t);if(!a)return null;let i="";return a.url?i=decodeURIComponent(a.url.substring(a.url.lastIndexOf("/")+1)):a.originalName&&(i=a.originalName),{...a,fileName:i}},[t,n]);return e?s.jsxs("span",{className:"text-[8px]",children:[s.jsx("strong",{className:"me-1",children:"Source Document:"}),e.url?s.jsxs("a",{href:e.url,target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:[e.fileName,e.name?` ( ${e.name} )`:""]}):s.jsx("span",{children:e.fileName||e.name||"Unknown Document"})]}):null}const xe=({count:o,counts:n,currentPage:t,totalPages:e,onChangeCount:a,goToPage:i})=>{const r=n.map(c=>({label:c,value:c}));return s.jsxs("div",{className:"w-full flex items-center justify-between px-4 py-2",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx("span",{className:"mr-2 min-w-max",children:"Rows per page"}),s.jsx(Z,{className:"border border-gray-300 rounded px-2 py-1",value:o,options:r,showClear:!1,onChange:c=>a(c)})]}),s.jsxs("div",{className:"flex items-center gap-6",children:[s.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(1),disabled:t===1,children:"«"}),s.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(t-1),disabled:t===1,children:"‹"}),s.jsxs("span",{className:"px-2 text-sm font-medium",children:[t," of ",e||1]}),s.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(t+1),disabled:t>=e||!e,children:"›"}),s.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(e),disabled:t>=e||!e,children:"»"})]})]})},Be=Object.freeze(Object.defineProperty({__proto__:null,default:ue},Symbol.toStringTag,{value:"Module"}));export{ue as K,ke as a,Be as b,Le as g,$e as u};
