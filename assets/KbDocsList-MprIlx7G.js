import{c as u,R as G,l as W,u as m,o as H,r as x,j as t,h as g}from"./AlertSnackbar-BBOi9bHj.js";import{k as P,g as I,l as Q,r as J,p,c as $}from"./index-CUzqN5ta.js";import{S as X}from"./delete-BYa5uglT.js";import{S as Z}from"./download-CJnziux0.js";import{S as ee}from"./edit-B3Se8WZw.js";import{S as te}from"./plus-MhxGst-q.js";import{S as se}from"./search-DFPqfhni.js";import"./Button-htJsKnEd.js";import{B as h}from"./Button-Cjbknt0d.js";import{S as oe}from"./SelectBox-zddttI4M.js";import{T as ne}from"./TextBox-vTD9KzNe.js";import{s as E,h as A}from"./utils-BPLOM7gE.js";import{u as k}from"./useSelectedBot-D0BiDtF-.js";import{f as L}from"./bots-BKYCEHOt.js";import{P as ae}from"./PageHeader-BsmArPDS.js";import{S as ie}from"./send-DIJqnNt5.js";import{F as re,a as ce,d as le}from"./index-C1Y6_lvp.js";const d=W(()=>({page:1,rowsPerPage:10,totalDocs:0,docsList:[],isLoading:!1,kbDocs:{}}));function de(){const n=u(a=>a.organizationId),[o]=k();G.useEffect(()=>{ue()},[o,n]);const s=d(a=>a.docsList),e=d(a=>a.isLoading);return[s,e]}async function ue(n=1,o=10){const{organizationId:s}=u.getState(),{selectedBotId:e}=m.getState();if(!s||!e)return;const{botId:a}=d.getState(),i={page:n,rowsPerPage:o,isLoading:!0};a!==e&&(i.docsList=[]),d.setState(i);const c=await P.get(`/bot/${s}/${e}/knowledge-base/list`);d.setState({botId:e,docsList:c,totalDocs:c.length,isLoading:!1})}async function me(n){const{selectedBotId:o}=m.getState(),{organizationId:s}=u.getState(),{kbDocs:e}=d.getState(),a=await I(`/bot/${s}/${o}/knowledge-base/list`);d.setState(i=>({kbDocs:{...i.docsList||{},[String(o)]:a}}))}async function fe(n){const{selectedBotId:o}=m.getState(),{organizationId:s}=u.getState();if(!o)throw new Error("No bot selected");const e=await p(`/bot/${s}/${o}/knowledge-base`,n);return d.setState(a=>{const i=[...a.docsList||[]];if(!Array.isArray(i))return{docsList:[e],totalDocs:1};if(n._id){const c=i.findIndex(l=>l._id===e._id);c>=0?i[c]=e:i.push(e)}else i.push(e);return{docsList:i,totalDocs:i.length}}),e}async function xe(n){const{selectedBotId:o}=m.getState(),{organizationId:s}=u.getState();if(!o)throw new Error("No bot selected");await J(`/bot/${s}/${o}/knowledge-base/${n}`,n),d.setState(e=>{const i=[...e.docsList||[]].filter(c=>c._id!==n);return{docsList:i,totalDocs:i.length}})}async function Te(n){if(!n?.length)return[];const{organizationId:o}=u.getState(),{selectedBotId:s}=m.getState();return await I(`/bot/${o}/${s}/knowledge-base/list?${n.map(e=>`docIds=${e}`).join("&")}`)}async function ge(){const{organizationId:n,botsMap:o}=u.getState(),{selectedBotId:s}=m.getState(),e=`/bot/${n}/${s}/knowledge-base/download`,a=await I(e),i=o[String(s)]?.botName||"KBDocs";Q(a,i+"_"+H().format("YYYYMMDD")+".csv")}async function Re(n){const{organizationId:o}=u.getState(),{selectedBotId:s}=m.getState(),e=await p(`/bot/${o}/${s}/add-training-media`,n);e.trainingMedia?s?(L(s,{trainingMedia:e.trainingMedia}),await _(s,o)):console.error("Bot ID is undefined."):console.warn("trainingMedia is null or undefined.")}async function qe(n){const{organizationId:o}=u.getState(),{selectedBotId:s}=m.getState(),e=new FormData;if(e.append("file",n),!(!o||!s))try{const a=await p(`/bot/${o}/${s}/add-training-media`,e);L(s,{trainingMedia:a.trainingMedia}),await _(s,o)}catch{throw new Error("File upload failed. Please try again.")}}async function _(n,o){const s=await p(`/bot/${o}/${n}/knowledge-base/train`,{});return d.setState(e=>{const a={...e.kbDocs||{}};return delete a[n],{kbDocs:a}}),me().catch(e=>console.error("Error fetching Knowledge base content:",e)),s}async function he(n,o,s){const e=await p(`/bot/${o}/${s}/add-bot-tax-details`,n),{_id:a,botDetailsForVerification:i}=e;return L(a,{botDetailsForVerification:i}),i}function z({onDone:n,initial:o,onUpdate:s}){const[e,a]=x.useState(o||{question:"",content:"",_id:""}),i=(l,b)=>{a(D=>({...D,[l]:b}))},c=async()=>{const l=await fe(e);s?.(l),n()};return t.jsxs("div",{className:"flex flex-col gap-4",children:[t.jsx("div",{className:"font-bold text-lg pb-1 text-center",children:"Add document"}),t.jsxs(re,{value:e,onChange:a,children:[t.jsx(ce,{field:"question",placeholder:"Provide title or question for the content",label:"Question",wrapperClassName:"h-6",onChange:l=>i("question",l)}),t.jsx(le,{field:"content",placeholder:"Provide content or answer for the question",label:"Content",className:"h-24",onChange:l=>i("content",l)})]}),t.jsx("div",{className:"text-center",children:t.jsx(h,{icon:t.jsx(ie,{}),size:"lg",type:"rounded",onClick:c,className:"bg-[#49d4a1]"})})]})}function pe(n){const{activeIndex:o,onNavigate:s=()=>{},docsList:e,onUpdate:a}=n,i=u(r=>r.organizationId),[c]=k(),[l,b]=de(),D=e??l,[w,F]=x.useState(10),[S,N]=x.useState(1),[j,M]=x.useState(""),T=[10,15,20,25],C=(D||[]).filter(r=>!j||r.question?.toLowerCase().includes(j.toLowerCase())||r.content?.toLowerCase().includes(j.toLowerCase())),y=Math.ceil(C.length/w),v=(S-1)*w,R=v+w,B=C.slice(v,R),q=()=>A(),K=()=>E(t.jsx(z,{onDone:q,onUpdate:a}),{showCloseButton:!0,width:"700px"}),V=async()=>{try{await ge(),g(!0,"Documents downloaded successfully","success")}catch(r){console.error("Error while downloading docs:",r),g(!0,"Failed to download documents","error")}};x.useEffect(()=>{S>y&&N(1)},[C.length,y,S]);const U=r=>{const f=typeof r=="string"?parseInt(r,10):r;typeof f=="number"&&!isNaN(f)&&(F(f),N(1))},O=r=>{r<1||r>y||N(r)},Y=async()=>{try{await he({botDetailsForVerification:{integrationUrl:""}},i,c)?g(!0,"The bot deployed successfully","success"):g(!0,"Not able to deploy the bot. Try after sometime!","error"),o&&s(o+1)}catch(r){console.error("Error during bot verification:",r),g(!0,"Not able to verify the bot. Try after sometime!","error")}};return t.jsxs("div",{className:"flex flex-col min-h-full",children:[!e&&!o&&t.jsx("div",{className:"mb-4",children:t.jsx(ae,{title:"Chat Bot Knowledge",icon:te,onClick:K})}),!e&&!o&&t.jsx("div",{className:"flex justify-between items-center py-3 px-2",children:t.jsxs("div",{className:"ml-auto flex gap-2",children:[t.jsx(ne,{value:j,placeholder:"Search",onChange:r=>M(r.target.value),iconRight:se,className:"py-3"}),t.jsx(h,{icon:t.jsx(Z,{}),size:"sm",type:"secondary",className:"align-middle",onClick:V,title:"Download as CSV"})]})}),t.jsxs("div",{className:$("w-full border border-mildGreyBGAlt rounded bg-white flex-1 flex flex-col",{"opacity-50":b}),children:[t.jsx("div",{className:"flex-1",children:b?t.jsx("div",{className:"flex justify-center items-center h-32 text-gray-500",children:"Loading..."}):B.length===0?t.jsx("div",{className:"flex justify-center items-center h-32 text-gray-500",children:"No documents found."}):B.map((r,f)=>t.jsx(be,{doc:r,index:v+f,onUpdate:a},r._id))}),!e&&t.jsx("div",{className:"w-full flex flex-row px-4 py-3 gap-8 border-t border-gray-100 bg-white mt-auto",children:t.jsx(Se,{count:w,counts:T,currentPage:S,totalPages:y,onChangeCount:U,goToPage:O})})]}),o&&!e&&t.jsx("div",{className:"flex mt-6 justify-end",children:t.jsx(h,{label:"GENERATE",onClick:Y})})]})}function be({doc:n,index:o,onUpdate:s}){const[,e]=k(),a=()=>{E(t.jsx(z,{onDone:A,initial:{question:n.question||"",content:n.content||"",_id:n._id},onUpdate:s}),{showCloseButton:!0,width:"700px"})},i=async c=>{console.log("Deleting document with ID:",c),await xe(c)};return t.jsxs("div",{className:$("w-full flex flex-row px-4 py-3 gap-8 border-b border-gray-100",{"bg-white":o%2!==0,"bg-[#f7f7f7]":o%2===0}),children:[t.jsxs("div",{className:"flex flex-col gap-1 flex-1",children:[!!n.question&&t.jsx("span",{className:"font-normal text-md",children:n.question}),t.jsx("div",{className:"text-xs overflow-hidden line-clamp-3",children:n.content}),!!n.sourceDocument&&e?.trainingMedia?.length>0&&t.jsx(we,{document:n,trainingMedia:e.trainingMedia})]}),t.jsxs("div",{className:"flex flex-row my-auto w-[130px]",children:[t.jsx(h,{icon:t.jsx(X,{height:24,width:24}),type:"plain",className:"me-8",onClick:()=>i(n._id)}),t.jsx(h,{icon:t.jsx(ee,{height:24,width:24}),type:"plain",className:"me-8",onClick:a})]})]})}function we({document:n,trainingMedia:o}){const s=n.sourceDocument,e=x.useMemo(()=>{if(!o||!s)return null;const a=o.find(c=>c.docId===s);if(!a)return null;let i="";return a.url?i=decodeURIComponent(a.url.substring(a.url.lastIndexOf("/")+1)):a.originalName&&(i=a.originalName),{...a,fileName:i}},[s,o]);return e?t.jsxs("span",{className:"text-[8px]",children:[t.jsx("strong",{className:"me-1",children:"Source Document:"}),e.url?t.jsxs("a",{href:e.url,target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:[e.fileName,e.name?` ( ${e.name} )`:""]}):t.jsx("span",{children:e.fileName||e.name||"Unknown Document"})]}):null}const Se=({count:n,counts:o,currentPage:s,totalPages:e,onChangeCount:a,goToPage:i})=>{const c=o.map(l=>({label:l,value:l}));return t.jsxs("div",{className:"w-full flex items-center justify-between px-4 py-2",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("span",{className:"mr-2 min-w-max",children:"Rows per page"}),t.jsx(oe,{className:"border border-gray-300 rounded px-2 py-1",value:n,options:c,showClear:!1,onChange:l=>a(l)})]}),t.jsxs("div",{className:"flex items-center gap-6",children:[t.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(1),disabled:s===1,children:"«"}),t.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(s-1),disabled:s===1,children:"‹"}),t.jsxs("span",{className:"px-2 text-sm font-medium",children:[s," of ",e||1]}),t.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(s+1),disabled:s>=e||!e,children:"›"}),t.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(e),disabled:s>=e||!e,children:"»"})]})]})},Ke=Object.freeze(Object.defineProperty({__proto__:null,default:pe},Symbol.toStringTag,{value:"Module"}));export{pe as K,Re as a,Ke as b,Te as g,qe as u};
