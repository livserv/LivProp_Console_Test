import{c as f,R as G,h as W,d as m,r as x,j as s,f as C}from"./index-Chs6WAJT.js";import{k as H,g as $,r as P,p as g,c as B}from"./ajax-Bc_xABO8.js";import{S as Q}from"./delete-Bna20Msy.js";import{S as J}from"./edit-BxuzMKAg.js";import{S as X}from"./plus-cto--LAF.js";import{B as w}from"./Button-B9ZuVWNA.js";import{S as Y}from"./TextBox-KB_6gu-1.js";import{s as E,h as A}from"./utils-B3TvvZ68.js";import{u as v}from"./useSelectedBot-BtZYghz0.js";import{f as I}from"./bots-Dt5pBvaE.js";import{P as Z}from"./PageHeader-a_MAa7SV.js";import{S as ee}from"./send-C-rbk9U4.js";import{F as te,a as se,d as oe}from"./index-ZnT7VdZO.js";const d=W(()=>({page:1,rowsPerPage:10,totalDocs:0,docsList:[],isLoading:!1,kbDocs:{}}));function ne(){const o=f(a=>a.organizationId),[n]=v();G.useEffect(()=>{ae()},[n,o]);const t=d(a=>a.docsList),e=d(a=>a.isLoading);return[t,e]}async function ae(o=1,n=10){const{organizationId:t}=f.getState(),{selectedBotId:e}=m.getState();if(!t||!e)return;const{botId:a}=d.getState(),i={page:o,rowsPerPage:n,isLoading:!0};a!==e&&(i.docsList=[]),d.setState(i);const r=await H.get(`/bot/${t}/${e}/knowledge-base/list`);d.setState({botId:e,docsList:r,totalDocs:r.length,isLoading:!1})}async function ie(o){const{selectedBotId:n}=m.getState(),{organizationId:t}=f.getState(),{kbDocs:e}=d.getState(),a=await $(`/bot/${t}/${n}/knowledge-base/list`);d.setState(i=>({kbDocs:{...i.docsList||{},[String(n)]:a}}))}async function re(o){const{selectedBotId:n}=m.getState(),{organizationId:t}=f.getState();if(!n)throw new Error("No bot selected");const e=await g(`/bot/${t}/${n}/knowledge-base`,o);return d.setState(a=>{const i=[...a.docsList||[]];if(!Array.isArray(i))return{docsList:[e],totalDocs:1};if(o._id){const r=i.findIndex(l=>l._id===e._id);r>=0?i[r]=e:i.push(e)}else i.push(e);return{docsList:i,totalDocs:i.length}}),e}async function ce(o){const{selectedBotId:n}=m.getState(),{organizationId:t}=f.getState();if(!n)throw new Error("No bot selected");await P(`/bot/${t}/${n}/knowledge-base/${o}`,o),d.setState(e=>{const i=[...e.docsList||[]].filter(r=>r._id!==o);return{docsList:i,totalDocs:i.length}})}async function Ie(o){if(!(o!=null&&o.length))return[];const{organizationId:n}=f.getState(),{selectedBotId:t}=m.getState();return await $(`/bot/${n}/${t}/knowledge-base/list?${o.map(e=>`docIds=${e}`).join("&")}`)}async function Le(o){const{organizationId:n}=f.getState(),{selectedBotId:t}=m.getState(),e=await g(`/bot/${n}/${t}/add-training-media`,o);e.trainingMedia?t?(I(t,{trainingMedia:e.trainingMedia}),await _(t,n)):console.error("Bot ID is undefined."):console.warn("trainingMedia is null or undefined.")}async function ke(o){const{organizationId:n}=f.getState(),{selectedBotId:t}=m.getState(),e=new FormData;if(e.append("file",o),!(!n||!t))try{const a=await g(`/bot/${n}/${t}/add-training-media`,e);I(t,{trainingMedia:a.trainingMedia}),await _(t,n)}catch{throw new Error("File upload failed. Please try again.")}}async function _(o,n){const t=await g(`/bot/${n}/${o}/knowledge-base/train`,{});return d.setState(e=>{const a={...e.kbDocs||{}};return delete a[o],{kbDocs:a}}),ie().catch(e=>console.error("Error fetching Knowledge base content:",e)),t}async function le(o,n,t){const e=await g(`/bot/${n}/${t}/add-bot-tax-details`,o),{_id:a,botDetailsForVerification:i}=e;return I(a,{botDetailsForVerification:i}),i}function z({onDone:o,initial:n}){const[t,e]=x.useState(n||{question:"",content:"",_id:""}),a=(r,l)=>{e(j=>({...j,[r]:l}))},i=async()=>{await re(t),o()};return s.jsxs("div",{className:"flex flex-col gap-4",children:[s.jsx("div",{className:"font-bold text-lg pb-1 text-center",children:"Add document"}),s.jsxs(te,{value:t,onChange:e,children:[s.jsx(se,{field:"question",placeholder:"Provide title or question for the content",label:"Question",wrapperClassName:"h-6",onChange:r=>a("question",r)}),s.jsx(oe,{field:"content",placeholder:"Provide content or answer for the question",label:"Content",className:"h-24",onChange:r=>a("content",r)})]}),s.jsx("div",{className:"text-center",children:s.jsx(w,{icon:s.jsx(ee,{}),size:"lg",type:"rounded",onClick:i,className:"bg-[#49d4a1]"})})]})}function de(o){const{activeIndex:n,onNavigate:t=()=>{},docsList:e}=o,a=f(c=>c.organizationId),[i]=v(),[r,l]=ne(),j=e??r,[h,F]=x.useState(10),[b,S]=x.useState(1),[N,M]=x.useState(""),q=[10,15,20,25],D=(j||[]).filter(c=>{var u,k;return!N||((u=c.question)==null?void 0:u.toLowerCase().includes(N.toLowerCase()))||((k=c.content)==null?void 0:k.toLowerCase().includes(N.toLowerCase()))}),p=Math.ceil(D.length/h),y=(b-1)*h,R=y+h,L=D.slice(y,R),T=()=>A(),K=()=>E(s.jsx(z,{onDone:T}),{showCloseButton:!0,width:"700px"});x.useEffect(()=>{b>p&&S(1)},[D.length,p,b]);const U=c=>{const u=typeof c=="string"?parseInt(c,10):c;typeof u=="number"&&!isNaN(u)&&(F(u),S(1))},V=c=>{c<1||c>p||S(c)},O=async()=>{try{await le({botDetailsForVerification:{integrationUrl:""}},a,i)?C(!0,"The bot deployed successfully","success"):C(!0,"Not able to deploy the bot. Try after sometime!","error"),n&&t(n+1)}catch(c){console.error("Error during bot verification:",c),C(!0,"Not able to verify the bot. Try after sometime!","error")}};return s.jsxs("div",{className:"flex flex-col min-h-full",children:[!e&&!n&&s.jsx("div",{className:"mb-4",children:s.jsx(Z,{title:"Chat Bot Knowledge",icon:X,search:!0,onSearchChange:M,onClick:K})}),s.jsxs("div",{className:B("w-full border border-mildGreyBGAlt rounded bg-white flex-1 flex flex-col",{"opacity-50":l}),children:[s.jsx("div",{className:"flex-1",children:l?s.jsx("div",{className:"flex justify-center items-center h-32 text-gray-500",children:"Loading..."}):L.length===0?s.jsx("div",{className:"flex justify-center items-center h-32 text-gray-500",children:"No documents found."}):L.map((c,u)=>s.jsx(ue,{doc:c,index:y+u},c._id))}),!e&&s.jsx("div",{className:"w-full flex flex-row px-4 py-3 gap-8 border-t border-gray-100 bg-white mt-auto",children:s.jsx(me,{count:h,counts:q,currentPage:b,totalPages:p,onChangeCount:U,goToPage:V})})]}),n&&!e&&s.jsx("div",{className:"flex mt-6 justify-end",children:s.jsx(w,{label:"GENERATE",onClick:O})})]})}function ue({doc:o,index:n}){var i;const[,t]=v(),e=()=>{E(s.jsx(z,{onDone:A,initial:{question:o.question||"",content:o.content||"",_id:o._id}}),{showCloseButton:!0,width:"700px"})},a=async r=>{console.log("Deleting document with ID:",r),await ce(r)};return s.jsxs("div",{className:B("w-full flex flex-row px-4 py-3 gap-8 border-b border-gray-100",{"bg-white":n%2!==0,"bg-[#f7f7f7]":n%2===0}),children:[s.jsxs("div",{className:"flex flex-col gap-1 flex-1",children:[!!o.question&&s.jsx("span",{className:"font-normal text-md",children:o.question}),s.jsx("div",{className:"text-xs overflow-hidden line-clamp-3",children:o.content}),!!o.sourceDocument&&((i=t==null?void 0:t.trainingMedia)==null?void 0:i.length)>0&&s.jsx(fe,{document:o,trainingMedia:t.trainingMedia})]}),s.jsxs("div",{className:"flex flex-row my-auto w-[130px]",children:[s.jsx(w,{icon:s.jsx(Q,{height:24,width:24}),type:"plain",className:"me-8",onClick:()=>a(o._id)}),s.jsx(w,{icon:s.jsx(J,{height:24,width:24}),type:"plain",className:"me-8",onClick:e})]})]})}function fe({document:o,trainingMedia:n}){const t=o.sourceDocument,e=x.useMemo(()=>{if(!n||!t)return null;const a=n.find(r=>r.docId===t);if(!a)return null;let i="";return a.url?i=decodeURIComponent(a.url.substring(a.url.lastIndexOf("/")+1)):a.originalName&&(i=a.originalName),{...a,fileName:i}},[t,n]);return e?s.jsxs("span",{className:"text-[8px]",children:[s.jsx("strong",{className:"me-1",children:"Source Document:"}),e.url?s.jsxs("a",{href:e.url,target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline",children:[e.fileName,e.name?` ( ${e.name} )`:""]}):s.jsx("span",{children:e.fileName||e.name||"Unknown Document"})]}):null}const me=({count:o,counts:n,currentPage:t,totalPages:e,onChangeCount:a,goToPage:i})=>{const r=n.map(l=>({label:l,value:l}));return s.jsxs("div",{className:"w-full flex items-center justify-between px-4 py-2",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx("span",{className:"mr-2 min-w-max",children:"Rows per page"}),s.jsx(Y,{className:"border border-gray-300 rounded px-2 py-1",value:o,options:r,showClear:!1,onChange:l=>a(l)})]}),s.jsxs("div",{className:"flex items-center gap-6",children:[s.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(1),disabled:t===1,children:"«"}),s.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(t-1),disabled:t===1,children:"‹"}),s.jsxs("span",{className:"px-2 text-sm font-medium",children:[t," of ",e||1]}),s.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(t+1),disabled:t>=e||!e,children:"›"}),s.jsx("button",{className:"font-bold text-2xl disabled:text-[#695A5A]",onClick:()=>i(e),disabled:t>=e||!e,children:"»"})]})]})},$e=Object.freeze(Object.defineProperty({__proto__:null,default:de},Symbol.toStringTag,{value:"Module"}));export{de as K,Le as a,$e as b,Ie as g,ke as u};
